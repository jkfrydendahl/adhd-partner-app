<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ADHD Partner Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 36 36'><text x='52%' y='60%' font-size='34' text-anchor='middle' dominant-baseline='middle'>ğŸ§ </text></svg>">
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#2a9d8f">

  <style>
    :root {
      --primary: #2a9d8f;
      --primary-light: #3dbaa9;
      --accent: #e0f5f1;
      --accent-warm: #f4a261;
      --background: linear-gradient(135deg, #edf7f6, #e0f5f1);
      --text: #2d3436;
      --text-muted: #636e72;
      --shadow: rgba(0, 0, 0, 0.08);
      --card-bg: #ffffff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
      background: var(--background);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    .container {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 1.25rem;
      box-shadow: 0 10px 20px var(--shadow);
      max-width: 640px;
      width: 100%;
      text-align: center;
      position: relative;
    }

    h1 {
      margin-top: 0;
      font-size: 1.8rem;
      color: var(--primary);
    }

    /* --- Buttons --- */
    .notif-button {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: rgba(42, 157, 143, 0.1);
      border: none;
      color: var(--primary);
      padding: 0.4rem 0.9rem;
      border-radius: 0.75rem;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      backdrop-filter: blur(4px);
    }
    .notif-button:hover {
      background: rgba(42, 157, 143, 0.2);
      color: #1e7a6f;
      box-shadow: 0 2px 6px rgba(42, 157, 143, 0.3);
    }

    .refresh-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(42, 157, 143, 0.1);
      border: none;
      color: var(--primary);
      padding: 0.4rem 0.9rem;
      border-radius: 0.75rem;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      backdrop-filter: blur(4px);
    }
    .refresh-button:hover {
      background: rgba(42, 157, 143, 0.2);
      color: #1e7a6f;
      box-shadow: 0 2px 6px rgba(42, 157, 143, 0.3);
    }

    /* --- Reminder of the Day --- */
    .reminder-of-the-day {
      background: var(--accent);
      border-left: 4px solid var(--primary);
      border-radius: 0.75rem;
      padding: 1.25rem 1.5rem;
      margin: 2rem 0 1.5rem;
      text-align: left;
    }

    .reminder-of-the-day .label {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .reminder-of-the-day .text {
      font-size: 1.15rem;
      line-height: 1.5;
      color: var(--text);
    }

    .reminder-emoji {
      font-size: 2em;
      margin-top: 0.75rem;
    }

    /* --- Divider --- */
    .divider {
      border: none;
      border-top: 2px solid var(--accent);
      margin: 1.5rem 0;
    }

    /* --- Full List --- */
    .all-reminders-heading {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 1rem;
      text-align: left;
    }

    .reminder-list {
      list-style: none;
      padding: 0;
      margin: 0;
      text-align: left;
    }

    .reminder-list li {
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      background: #f9fffe;
      border-radius: 0.6rem;
      font-size: 0.95rem;
      line-height: 1.45;
      border: 1px solid rgba(42, 157, 143, 0.1);
      transition: background 0.15s;
    }

    .reminder-list li:hover {
      background: var(--accent);
    }

    .reminder-list li .emoji {
      margin-right: 0.5rem;
    }

    .reminder-list li.highlighted {
      background: var(--accent);
      border-left: 3px solid var(--accent-warm);
      font-weight: 600;
    }

    /* --- Version --- */
    #app-version {
      margin-top: 2rem;
      font-size: 0.6rem;
      color: #9aa0a6;
      user-select: text;
    }

    /* --- Responsive --- */
    @media (max-width: 480px) {
      body {
        padding: 1rem 0.5rem;
      }
      .container {
        padding: 1.5rem;
        border-radius: 1rem;
      }
      h1 {
        margin-top: 30px;
        font-size: 1.4rem;
      }
      .reminder-of-the-day .text {
        font-size: 1rem;
      }
      .notif-button,
      .refresh-button {
        padding: 0.3rem 0.7rem;
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <button class="notif-button" id="enable-push">ğŸ”” Notify</button>
  <button class="refresh-button" onclick="resetAndRefresh()">New tip ğŸ”„</button>

  <h1 class="main-title">ADHD Partner Guide</h1>

  <!-- Reminder of the Day -->
  <div class="reminder-of-the-day">
    <div class="label">ğŸ’¡ Reminder of the Day</div>
    <div class="text" id="reminder-of-the-day-text">Loadingâ€¦</div>
  </div>
  <div class="reminder-emoji" id="reminder-emoji"></div>

  <hr class="divider">

  <!-- Full List -->
  <div class="all-reminders-heading">All ways you can help</div>
  <ul class="reminder-list" id="reminder-list"></ul>

  <div id="app-version"></div>
</div>

<!-- ===================== Version check ===================== -->
<script>
  const APP_VERSION = '26.2.9.1';
  const prev = localStorage.getItem('app-version');
  if (prev !== APP_VERSION) {
    localStorage.setItem('app-version', APP_VERSION);
    location.replace(location.pathname + location.search
      + (location.search ? '&' : '?') + 'v=' + APP_VERSION);
  }
  console.log('ADHD Partner Guide launched â€“ version', APP_VERSION);
</script>

<!-- ===================== Service Worker ===================== -->
<script>
  window.addEventListener('DOMContentLoaded', () => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js', { scope: './' })
        .then(r => console.log('SW registered, scope:', r.scope))
        .catch(console.error);
    }
    const vel = document.getElementById('app-version');
    if (vel && typeof APP_VERSION !== 'undefined') {
      vel.textContent = `v${APP_VERSION}`;
    }
  });
</script>

<!-- ===================== Push Notifications ===================== -->
<script>
  // âš ï¸  Replace with YOUR Vercel backend URL and VAPID public key
  const VERCEL_BACKEND = 'https://adhd-partner-app.vercel.app';
  const PUBLIC_VAPID_KEY = 'YOUR_VAPID_PUBLIC_KEY_HERE';

  function isIOS() { return /iphone|ipad|ipod/i.test(navigator.userAgent); }
  function isStandalone() {
    return window.matchMedia?.('(display-mode: standalone)').matches
      || window.navigator.standalone;
  }
  function urlBase64ToUint8Array(s) {
    const p = '='.repeat((4 - s.length % 4) % 4);
    const b = (s + p).replace(/-/g, '+').replace(/_/g, '/');
    const r = atob(b), a = new Uint8Array(r.length);
    for (let i = 0; i < r.length; i++) a[i] = r.charCodeAt(i);
    return a;
  }

  async function enablePushVerbose() {
    try {
      if (!('serviceWorker' in navigator)) throw new Error('ServiceWorker not supported');
      if (isIOS() && !isStandalone()) throw new Error('Install to Home Screen first');

      const probe = await fetch('./sw.js', { cache: 'no-store' });
      if (!probe.ok) throw new Error('sw.js not reachable (' + probe.status + ')');

      const reg = await navigator.serviceWorker.register('./sw.js');
      await navigator.serviceWorker.ready;
      await reg.update();

      const perm = await Notification.requestPermission();
      if (perm !== 'granted') throw new Error('Permission not granted');

      const keyBytes = urlBase64ToUint8Array(PUBLIC_VAPID_KEY);
      if (keyBytes.length < 65) throw new Error('Bad VAPID public key â€“ have you set it?');

      const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: keyBytes
      });
      console.log('Push subscribed, endpoint:', sub.endpoint);

      const resp = await fetch(`${VERCEL_BACKEND}/api/subscribe`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sub)
      });
      if (!resp.ok) throw new Error('Subscribe API failed: ' + resp.status);

      alert('Push notifications enabled! ğŸ‰');
    } catch (err) {
      console.error('enablePush failed:', err);
      alert('Push setup failed: ' + (err?.message || err));
    }
  }

  document.getElementById('enable-push').addEventListener('click', enablePushVerbose);
</script>

<!-- ===================== Reminders Data & Logic ===================== -->
<script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  REMINDERS â€“ replace / extend this array
  //  Each entry: { text: "...", emoji: "..." }
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const reminders = [
    { text: "They're not ignoring you â€” their brain filters input differently. Repeat important things without frustration.", emoji: "ğŸ§ " },
    { text: "Written reminders work better than verbal ones. Try leaving a note or sending a text.", emoji: "ğŸ“" },
    { text: "Don't take unfinished tasks personally. Offer to do them together instead of pointing them out.", emoji: "ğŸ¤" },
    { text: "Celebrate small wins. Finishing a task that seems simple to you may have taken them enormous effort.", emoji: "ğŸ‰" },
    { text: "Unexpected changes are extra hard. Give as much advance notice as possible.", emoji: "ğŸ“…" },
    { text: "Their emotional reactions can be intense. Validate first, problem-solve later.", emoji: "ğŸ’›" },
    { text: "Time blindness is real. Help with gentle time cues instead of 'you're late again'.", emoji: "â°" },
    { text: "A calm, clutter-free space helps their brain breathe. Tidy together, don't nag.", emoji: "ğŸ¡" },
    { text: "Routines are their anchor. Avoid disrupting established routines without discussion.", emoji: "âš“" },
    { text: "Hyperfocus isn't a choice â€” it's how their brain locks on. Agree on a signal to gently interrupt.", emoji: "ğŸ”" },
    { text: "Ask 'How can I help?' instead of 'Why didn't youâ€¦?' â€” it changes everything.", emoji: "ğŸ’¬" },
    { text: "They may need to move or fidget to concentrate. Don't mistake it for not paying attention.", emoji: "ğŸ¦‹" },
    { text: "Rejection sensitivity is painful. Choose your words carefully when giving feedback.", emoji: "ğŸ«‚" },
    { text: "Praise effort, not just results. The effort they put in is often invisible.", emoji: "â­" },
    { text: "Use external tools together: shared calendars, reminders, checklists.", emoji: "ğŸ“‹" },
    { text: "Patience isn't about lowering standards â€” it's about understanding a different brain.", emoji: "ğŸŒ±" },
    { text: "They're not lazy. Executive dysfunction makes starting tasks genuinely difficult.", emoji: "ğŸ§©" },
    { text: "Body doubling helps â€” just being in the same room while they work can make a huge difference.", emoji: "ğŸ‘¥" },
    { text: "Decision fatigue is real. Reduce choices when possible (e.g., 'A or B?' instead of 'What do you want?').", emoji: "ğŸ”€" },
    { text: "Learn about ADHD together. Understanding leads to empathy, empathy leads to connection.", emoji: "ğŸ“–" },
    { text: "Separate the person from the symptoms. They are not their ADHD.", emoji: "ğŸ’š" },
    { text: "Transitions between tasks are hard. Give a 5-minute warning before you need them to switch.", emoji: "ğŸ”„" },
    { text: "They may forget important dates. Set shared reminders instead of testing their memory.", emoji: "ğŸ—“ï¸" },
    { text: "Stimulation-seeking isn't reckless â€” their brain craves engagement. Channel it constructively.", emoji: "âš¡" },
    { text: "Short, clear instructions work best. One task at a time, not a list of five.", emoji: "1ï¸âƒ£" },
    { text: "They hear your tone before your words. A calm voice invites cooperation.", emoji: "ğŸµ" },
    { text: "Don't keep score. A relationship isn't a balance sheet.", emoji: "âš–ï¸" },
    { text: "Sleep matters enormously. Support good sleep habits without being controlling.", emoji: "ğŸ˜´" },
    { text: "Acknowledge that managing ADHD takes energy you can't see. They're often exhausted.", emoji: "ğŸ”‹" },
    { text: "Your needs matter too. Set boundaries with love, not resentment.", emoji: "ğŸ›¡ï¸" },
  ];

  // Emojis for the "reminder of the day" decorative display
  const dayEmojis = [
    "ğŸ§ ", "ğŸ’¡", "ğŸŒŸ", "âœ¨", "ğŸ’ª", "ğŸŒˆ", "ğŸ«¶", "ğŸ§©", "ğŸŒ»", "ğŸ¦‹",
    "ğŸ’š", "ğŸ¯", "ğŸŒ¿", "ğŸ”†", "ğŸ•Šï¸", "ğŸ’›", "ğŸª·", "ğŸŒŠ", "â˜€ï¸", "ğŸ¤—",
    "ğŸ”ï¸", "ğŸˆ", "ğŸ§¡", "ğŸ’™", "ğŸª´", "ğŸ", "ğŸŒ¸", "ğŸ¦Š", "ğŸŒ", "ğŸ€",
  ];

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Weighted random (same algorithm as love-app)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const year = new Date().getFullYear();

  function getWeightedIndex(array, keyPrefix, maxUses = 3) {
    const usageKey = `${keyPrefix}-${year}`;
    const usageMap = JSON.parse(localStorage.getItem(usageKey)) || {};

    const weights = array.map((_, i) => {
      const count = usageMap[i] || 0;
      return count >= maxUses ? 0 : 1 / (1 + count);
    });

    const total = weights.reduce((sum, w) => sum + w, 0);
    const cumulative = [];
    let running = 0;
    for (let i = 0; i < weights.length; i++) {
      running += weights[i] / total;
      cumulative.push(running);
    }

    const rand = Math.random();
    const index = cumulative.findIndex(c => rand <= c);

    usageMap[index] = (usageMap[index] || 0) + 1;
    localStorage.setItem(usageKey, JSON.stringify(usageMap));

    return index;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Render
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderDisplay(reminderIndex) {
    const reminder = reminders[reminderIndex];
    const emoji = dayEmojis[reminderIndex % dayEmojis.length] || "âœ¨";

    document.getElementById('reminder-of-the-day-text').textContent = reminder.text;
    document.getElementById('reminder-emoji').textContent = `${reminder.emoji} ${emoji}`;

    // Build full list
    const list = document.getElementById('reminder-list');
    list.innerHTML = '';
    reminders.forEach((r, i) => {
      const li = document.createElement('li');
      if (i === reminderIndex) li.classList.add('highlighted');
      li.innerHTML = `<span class="emoji">${r.emoji}</span>${r.text}`;
      list.appendChild(li);
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Daily cutover logic (same as love-app)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function ymdLocal(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  const CUTOVER_HOUR = 8, CUTOVER_MINUTE = 0;
  const DAILY_STATE_KEY = `dailyReminderState-${CUTOVER_HOUR}-${CUTOVER_MINUTE}-v1`;

  function getCutoverSlot(d = new Date()) {
    const now = new Date(d);
    const cut = new Date(now);
    cut.setHours(CUTOVER_HOUR, CUTOVER_MINUTE, 0, 0);
    const slotDate = (now < cut)
      ? new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1)
      : new Date(now.getFullYear(), now.getMonth(), now.getDate());
    return ymdLocal(slotDate);
  }

  function msUntilNextCutover(d = new Date()) {
    const next = new Date(d);
    next.setHours(CUTOVER_HOUR, CUTOVER_MINUTE, 0, 0);
    if (next <= d) next.setDate(next.getDate() + 1);
    return next - d;
  }

  function ensureDailyDisplay(forceNew = false) {
    const slot = getCutoverSlot();
    const saved = JSON.parse(localStorage.getItem(DAILY_STATE_KEY) || 'null');

    if (!saved || saved.slot !== slot || forceNew) {
      const reminderIndex = getWeightedIndex(reminders, 'reminderUsage');
      localStorage.setItem(DAILY_STATE_KEY, JSON.stringify({
        slot,
        reminderIndex,
        ts: Date.now()
      }));
      renderDisplay(reminderIndex);
    } else {
      renderDisplay(saved.reminderIndex);
    }

    // Schedule precise flip while the app stays open
    clearTimeout(window.__cutoverTimer);
    const ms = msUntilNextCutover();
    console.log(`Next cutover in ${(ms / 60000).toFixed(2)} min`);
    window.__cutoverTimer = setTimeout(() => {
      console.log('Cutover timer fired');
      ensureDailyDisplay(true);
    }, ms + 1000);
  }

  // Heartbeat: catch throttled timers / drift every 30s
  function startHeartbeat() {
    clearInterval(window.__dailyHeartbeat);
    window.__dailyHeartbeat = setInterval(() => {
      const slotNow = getCutoverSlot();
      const saved = JSON.parse(localStorage.getItem(DAILY_STATE_KEY) || 'null');
      if (!saved || saved.slot !== slotNow) {
        console.log('Heartbeat detected new slot â†’ refreshing');
        ensureDailyDisplay(true);
      }
    }, 30 * 1000);
  }

  // Run on load + on foreground / resume
  ensureDailyDisplay();
  startHeartbeat();
  window.addEventListener('visibilitychange', () => { if (!document.hidden) ensureDailyDisplay(); }, { passive: true });
  window.addEventListener('focus', () => ensureDailyDisplay(), { passive: true });
  window.addEventListener('pageshow', () => ensureDailyDisplay(), { passive: true });

  // Manual refresh
  window.resetAndRefresh = function () {
    const y = new Date().getFullYear();
    localStorage.removeItem('reminderUsage-' + y);
    localStorage.removeItem(DAILY_STATE_KEY);
    location.reload();
  };
</script>

</body>
</html>
